function w(e){return e.replace(/\./g,"-")}function S(){return Math.random().toString(36).substring(2,16)}function v(e=64){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";let r="";const n=new Uint8Array(e);return window.crypto.getRandomValues(n),n.forEach(a=>{r+=t[a%t.length]}),r}async function I(e){const r=new TextEncoder().encode(e),n=await window.crypto.subtle.digest("SHA-256",r);return k(n)}function k(e){const t=new Uint8Array(e);let r="";return t.forEach(n=>r+=String.fromCharCode(n)),btoa(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function p(){document.body.style.overflow="hidden"}function g(){document.body.style.overflow="auto"}async function L(){try{let e=localStorage.getItem("accessToken");const t="https://payment-service.dev.apero.vn";if(!e)throw new Error("Access token not found in localStorage");const r=await fetch(`${t}/saas-payment-service/v1/stripe/billing-portal-session`,{method:"POST",headers:{"x-api-bundleid":"com.astronex.hekaai",Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({callbackUrl:"/"})});if(!r.ok){const a=await r.json();throw new Error(`Request failed: ${r.status} - ${a.message||"Unknown error"}`)}return(await r.json()).url}catch{return null}}async function b(e){showLoadingScreen();let t=localStorage.getItem("accessToken");const r="https://payment-service.dev.apero.vn",n="com.astronex.hekaai";localStorage.getItem("redirectUri");const a=window.location.origin,i=await T(e);if(console.log("product: ",i),!i){hideLoadingScreen();return}console.log("product: ",i.price.id);try{const d={cart:[{stripePriceId:i.price.id,quantity:1,name:i.name}],successUrl:`${a}/payment/success`,cancelUrl:`${a}/payment/cancel`},c=await fetch(`${r}/saas-payment-service/v1/stripe/create-checkout-session`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,"x-api-bundleid":n},body:JSON.stringify(d)}),o=await c.json();hideLoadingScreen(),c.ok&&(o!=null&&o.url)?window.location.href=o.url:(window.location.href="/",hideLoadingScreen())}catch{window.location.href="/",hideLoadingScreen()}}async function T(e){const t="https://payment-service.dev.apero.vn",r="com.astronex.hekaai",n=localStorage.getItem("accessToken");try{const a=await fetch(`${t}/saas-payment-service/v1/stripe/products`,{method:"GET",headers:{Authorization:`Bearer ${n}`,"x-api-bundleid":r}}),i=await a.json();if(a.ok&&Array.isArray(i.data))return i.data.find(d=>{var c;return((c=d.price)==null?void 0:c.id)===e})}catch(a){console.error("Lỗi lấy sản phẩm:",a)}return null}const l=[];for(let e=0;e<256;++e)l.push((e+256).toString(16).slice(1));function x(e,t=0){return(l[e[t+0]]+l[e[t+1]]+l[e[t+2]]+l[e[t+3]]+"-"+l[e[t+4]]+l[e[t+5]]+"-"+l[e[t+6]]+l[e[t+7]]+"-"+l[e[t+8]]+l[e[t+9]]+"-"+l[e[t+10]]+l[e[t+11]]+l[e[t+12]]+l[e[t+13]]+l[e[t+14]]+l[e[t+15]]).toLowerCase()}let h;const _=new Uint8Array(16);function U(){if(!h){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");h=crypto.getRandomValues.bind(crypto)}return h(_)}const $=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),y={randomUUID:$};function A(e,t,r){var a;if(y.randomUUID&&!e)return y.randomUUID();e=e||{};const n=e.random??((a=e.rng)==null?void 0:a.call(e))??U();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,x(n)}async function j(e){p();const t=v(),r=await I(t);localStorage.setItem("pkce_code_verifier",t),localStorage.setItem("idp",e),localStorage.setItem("deviceId","device-"+A());const n=w("com.astronex.hekaai"),a="application",i=window.location.origin+window.location.pathname,d=S(),c=`https://llm-oauth.apero.vn/realms/${n}/protocol/openid-connect/auth?`+new URLSearchParams({response_type:"code",client_id:a,redirect_uri:i,scope:"openid device-id profile email ancestor-id address phone group-membership",code_challenge:r,code_challenge_method:"S256",state:d,kc_idp_hint:e,prompt:"consent select_account"});g(),window.location.href=c}async function f(){try{const e=localStorage.getItem("refreshToken"),t="https://llm-account-service.apero.vn",r="com.astronex.hekaai";if(!e){window.location.href=localStorage.getItem("redirectUri")||"/",localStorage.clear();return}(await fetch(`${t}/saas-user-service/v1/users/logout`,{method:"POST",headers:{"Content-Type":"application/json","x-api-bundleid":r},body:JSON.stringify({refreshToken:e})})).ok&&(window.location.href=localStorage.getItem("redirectUri")||"/"),localStorage.clear()}catch{}}async function D(e){const t=localStorage.getItem("priceId");localStorage.removeItem("priceId");const r=localStorage.getItem("pkce_code_verifier"),n=localStorage.getItem("idp"),a=localStorage.getItem("deviceId"),i="com.astronex.hekaai",d="https://llm-account-service.apero.vn",c=window.location.origin+window.location.pathname;e&&(p(),fetch(d+"/saas-user-service/v1/users/silent-login-sso",{method:"POST",headers:{"Content-Type":"application/json","x-api-bundleid":i},body:JSON.stringify({code:e,codeVerifier:r,redirectUri:c,deviceId:a,idp:n})}).then(o=>o.json()).then(o=>{var u,s;(u=o==null?void 0:o.data)!=null&&u.accessToken&&((s=o==null?void 0:o.data)!=null&&s.refreshToken)?(localStorage.setItem("accessToken",o.data.accessToken),localStorage.setItem("refreshToken",o.data.refreshToken),t?b(t):window.location.href=c):(g(),console.error("Login failed:",o),Swal.fire({title:"Login failed",text:"Please try again.",icon:"error",confirmButtonText:"OK"}).then(()=>{window.location.href=c}))}).catch(o=>{g(),console.error("Error during login:",o)}))}async function C(){var n,a;var e=localStorage.getItem("accessToken"),t="https://llm-account-service.apero.vn",r="com.astronex.hekaai";p();try{const i=await fetch(`${t}/saas-user-service/v1/users/me`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"x-api-bundleid":r}});g();const d=await i.json();if(i.ok&&d.data){const c=d.data;c.email&&localStorage.setItem("email",c.email);const o=((a=(n=c.groups)==null?void 0:n[0])==null?void 0:a.name)||null;o&&localStorage.setItem("group_name",o);const u=c.attributes||{};for(const s in u){const m=u[s];Array.isArray(m)&&localStorage.setItem(s,m[0])}return localStorage.getItem("gender")&&localStorage.getItem("year_of_birth")&&localStorage.getItem("activity")&&localStorage.getItem("measure_type")&&localStorage.getItem("current_weight")&&localStorage.getItem("current_height")&&localStorage.getItem("target_cal"),!1}else Swal.fire({title:"Session expired",text:"Please sign in again to continue.",icon:"warning",confirmButtonText:"OK"}).then(()=>{f(),showSignInModal(!0)})}catch{}g()}async function E(e){var c;let t=localStorage.getItem("accessToken");const r="com.astronex.hekaai",n="https://llm-account-service.apero.vn";if(!t){console.error("❌ Access token is missing");return}console.log("data: ",e);const d={attributes:["activity","goal","gender","year_of_birth","measure_type","current_weight","current_height","target_cal","goal_weight","start_date","end_date"].reduce((o,u)=>{const s=e[u];return s!==void 0&&s!==""&&(s.startsWith('"')&&s.endsWith('"')&&(s=s.slice(1,-1)),s.startsWith("'")&&s.endsWith("'")&&(s=s.slice(1,-1)),o[u]=s),o},{})};console.log("payload sau khi xử lý: ",d);try{const o=await fetch(`${n}/saas-user-service/v1/users/update`,{method:"PUT",headers:{"Content-Type":"application/json","x-api-bundleid":r,Authorization:`Bearer ${t}`},body:JSON.stringify(d)}),u=await o.json();o.ok&&u.data===!0||(((c=u==null?void 0:u.error)==null?void 0:c.message)==="Token expired"?f():console.error("❌ Update failed:",u))}catch(o){g(),console.error("❌ Error while updating profile:",o)}}export{b as a,L as c,C as g,f as h,j as l,D as s,E as u};
