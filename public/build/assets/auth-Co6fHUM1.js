import{s as m,h as p,g as S,a as w,b as I,c as k}from"./helpers-BIkqR0Wr.js";import{e as v}from"./tracking-cM1pk6uz.js";async function L(){try{let e=localStorage.getItem("accessToken");const t="https://payment-service.dev.apero.vn";if(!e)throw new Error("Access token not found in localStorage");const n=await fetch(`${t}/saas-payment-service/v1/stripe/billing-portal-session`,{method:"POST",headers:{"x-api-bundleid":"com.astronex.hekaai",Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({callbackUrl:"/"})});if(!n.ok){const c=await n.json();throw new Error(`Request failed: ${n.status} - ${c.message||"Unknown error"}`)}return(await n.json()).url}catch{return null}}async function b(e){var r;showLoadingScreen();let t=localStorage.getItem("accessToken");const n="https://api-heka.dev.apero.vn",a="com.astronex.hekaai";localStorage.getItem("redirectUri");const c=window.location.origin,l=await T(e);if(!l){hideLoadingScreen();return}const d=Math.random().toString(36).substring(2,15);localStorage.setItem("checkoutId",d),localStorage.setItem("package_id",e);try{const o={cart:[{stripePriceId:l.price.id,quantity:1,name:l.name}],successUrl:`${c}/payment/success?id=${d}`,cancelUrl:`${c}/payment/cancel?id=${d}`},i=await fetch(`${n}/api/v1/payment/create-checkout-session`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,"x-api-bundleid":a},body:JSON.stringify(o)}),g=await i.json();hideLoadingScreen(),i.ok&&((r=g==null?void 0:g.data)!=null&&r.url)?(localStorage.setItem("payment_redirect_from",window.location.pathname),v("checkout_view"),window.location.href=g.data.url):(window.location.href="/",hideLoadingScreen())}catch{window.location.href="/",hideLoadingScreen()}}async function T(e){const t="https://api-heka.dev.apero.vn";try{const n=await fetch(`${t}/api/v1/payment/products/prices`,{method:"GET"}),a=await n.json();if(n.ok&&Array.isArray(a.data)){const c=a.data.find(l=>l.id===e);return c||null}}catch(n){console.error("Lỗi lấy sản phẩm:",n)}return null}const s=[];for(let e=0;e<256;++e)s.push((e+256).toString(16).slice(1));function _(e,t=0){return(s[e[t+0]]+s[e[t+1]]+s[e[t+2]]+s[e[t+3]]+"-"+s[e[t+4]]+s[e[t+5]]+"-"+s[e[t+6]]+s[e[t+7]]+"-"+s[e[t+8]]+s[e[t+9]]+"-"+s[e[t+10]]+s[e[t+11]]+s[e[t+12]]+s[e[t+13]]+s[e[t+14]]+s[e[t+15]]).toLowerCase()}let h;const x=new Uint8Array(16);function U(){if(!h){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");h=crypto.getRandomValues.bind(crypto)}return h(x)}const $=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),f={randomUUID:$};function A(e,t,n){var c;if(f.randomUUID&&!e)return f.randomUUID();e=e||{};const a=e.random??((c=e.rng)==null?void 0:c.call(e))??U();if(a.length<16)throw new Error("Random bytes length must be >= 16");return a[6]=a[6]&15|64,a[8]=a[8]&63|128,_(a)}async function j(e){m(),console.log("VITE_KEYCLOAK_DOMAIN: ","https://sso.dev.apero.vn"),console.log("VITE_BACKEND_DOMAIN: ","https://id.dev.apero.vn"),console.log("VITE_PAYMENT_DOMAIN: ","https://payment-service.dev.apero.vn");const t=S(),n=await w(t);localStorage.setItem("pkce_code_verifier",t),localStorage.setItem("idp",e),localStorage.setItem("deviceId","device-"+A());const a=k("com.astronex.hekaai"),c="application",l=window.location.origin+window.location.pathname,d=I(),r=`https://sso.dev.apero.vn/realms/${a}/protocol/openid-connect/auth?`+new URLSearchParams({response_type:"code",client_id:c,redirect_uri:l,scope:"openid device-id profile email ancestor-id address phone group-membership",code_challenge:n,code_challenge_method:"S256",state:d,kc_idp_hint:e,prompt:"consent select_account"});p(),window.location.href=r}async function y(){try{const e=localStorage.getItem("refreshToken"),t="https://id.dev.apero.vn",n="com.astronex.hekaai";if(!e){window.location.href=localStorage.getItem("redirectUri")||"/",localStorage.clear();return}(await fetch(`${t}/saas-user-service/v1/users/logout`,{method:"POST",headers:{"Content-Type":"application/json","x-api-bundleid":n},body:JSON.stringify({refreshToken:e})})).ok&&(window.location.href=localStorage.getItem("redirectUri")||"/"),localStorage.clear()}catch{}}async function E(e){const t=localStorage.getItem("priceId");localStorage.removeItem("priceId");const n=localStorage.getItem("pkce_code_verifier"),a=localStorage.getItem("idp"),c=localStorage.getItem("deviceId"),l="com.astronex.hekaai",d="https://id.dev.apero.vn",r=window.location.origin+window.location.pathname;e&&(m(),fetch(d+"/saas-user-service/v1/users/silent-login-sso",{method:"POST",headers:{"Content-Type":"application/json","x-api-bundleid":l},body:JSON.stringify({code:e,codeVerifier:n,redirectUri:r,deviceId:c,idp:a})}).then(o=>o.json()).then(o=>{var i,g;(i=o==null?void 0:o.data)!=null&&i.accessToken&&((g=o==null?void 0:o.data)!=null&&g.refreshToken)?(localStorage.setItem("accessToken",o.data.accessToken),localStorage.setItem("refreshToken",o.data.refreshToken),t?b(t):window.location.href=r):(p(),console.error("Login failed:",o),Swal.fire({title:"Login failed",text:"Please try again.",icon:"error",confirmButtonText:"OK"}).then(()=>{window.location.href=r}))}).catch(o=>{p(),console.error("Error during login:",o)}))}async function C(){var a,c;var e=localStorage.getItem("accessToken"),t="https://id.dev.apero.vn",n="com.astronex.hekaai";m();try{const l=await fetch(`${t}/saas-user-service/v1/users/me`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"x-api-bundleid":n}});p();const d=await l.json();if(l.ok&&d.data){const r=d.data;r.email&&localStorage.setItem("email",r.email);const o=((c=(a=r.groups)==null?void 0:a[0])==null?void 0:c.name)||null;o&&localStorage.setItem("group_name",o);const i=r.attributes||{};for(const g in i){const u=i[g];Array.isArray(u)&&localStorage.setItem(g,u[0])}return localStorage.getItem("gender")&&localStorage.getItem("year_of_birth")&&localStorage.getItem("activity")&&localStorage.getItem("measure_type")&&localStorage.getItem("current_weight")&&localStorage.getItem("current_height")&&localStorage.getItem("target_cal"),!1}else Swal.fire({title:"Session expired",text:"Please sign in again to continue.",icon:"warning",confirmButtonText:"OK"}).then(()=>{y(),showSignInModal(!0)})}catch{}p()}async function P(e){var d;let t=localStorage.getItem("accessToken");const n="com.astronex.hekaai",a="https://id.dev.apero.vn";if(!t){console.error("❌ Access token is missing");return}const l={attributes:Object.entries(e).reduce((r,[o,i])=>(i!==void 0&&i!==""&&(typeof i=="string"&&(i=i.trim(),(i.startsWith('"')&&i.endsWith('"')||i.startsWith("'")&&i.endsWith("'"))&&(i=i.slice(1,-1))),r[o]=i),r),{})};try{const r=await fetch(`${a}/saas-user-service/v1/users/update`,{method:"PUT",headers:{"Content-Type":"application/json","x-api-bundleid":n,Authorization:`Bearer ${t}`},body:JSON.stringify(l)}),o=await r.json();r.ok&&o.data===!0||(((d=o==null?void 0:o.error)==null?void 0:d.message)==="Token expired"?y():console.error("❌ Update failed:",o))}catch(r){console.error("❌ Error while updating profile:",r)}finally{p()}}export{b as a,L as c,C as g,y as h,j as l,E as s,P as u};
