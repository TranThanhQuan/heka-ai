import{k as v,c as S,o as y,w as k,b as x,d as I,G as _,e as d,g as w,C as T}from"./app-DyDjBauY.js";import{_ as C}from"./_plugin-vue_export-helper-DlAUqK2U.js";function U(e){return e.replace(/\./g,"-")}function $(){return Math.random().toString(36).substring(2,16)}function L(e=64){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";let n="";const a=new Uint8Array(e);return window.crypto.getRandomValues(a),a.forEach(r=>{n+=t[r%t.length]}),n}async function j(e){const n=new TextEncoder().encode(e),a=await window.crypto.subtle.digest("SHA-256",n);return A(a)}function A(e){const t=new Uint8Array(e);let n="";return t.forEach(a=>n+=String.fromCharCode(a)),btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function h(){document.body.style.overflow="hidden"}function p(){document.body.style.overflow="auto"}async function Q(){try{let e=localStorage.getItem("accessToken");const t="https://payment-service.dev.apero.vn";if(!e)throw new Error("Access token not found in localStorage");const n=await fetch(`${t}/saas-payment-service/v1/stripe/billing-portal-session`,{method:"POST",headers:{"x-api-bundleid":"com.astronex.hekaai",Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({callbackUrl:"/"})});if(!n.ok){const r=await n.json();throw new Error(`Request failed: ${n.status} - ${r.message||"Unknown error"}`)}return(await n.json()).url}catch{return null}}async function B(e){showLoadingScreen();let t=localStorage.getItem("accessToken");const n="https://payment-service.dev.apero.vn",a="com.astronex.hekaai";localStorage.getItem("redirectUri");const r=window.location.origin,c=await O(e);if(console.log("product: ",c),!c){hideLoadingScreen();return}console.log("product: ",c.price.id);try{const s={cart:[{stripePriceId:c.price.id,quantity:1,name:c.name}],successUrl:`${r}/payment/success`,cancelUrl:`${r}/payment/cancel`},o=await fetch(`${n}/saas-payment-service/v1/stripe/create-checkout-session`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,"x-api-bundleid":a},body:JSON.stringify(s)}),l=await o.json();hideLoadingScreen(),o.ok&&(l!=null&&l.url)?window.location.href=l.url:(window.location.href="/",hideLoadingScreen())}catch{window.location.href="/",hideLoadingScreen()}}async function O(e){const t="https://payment-service.dev.apero.vn",n="com.astronex.hekaai",a=localStorage.getItem("accessToken");try{const r=await fetch(`${t}/saas-payment-service/v1/stripe/products`,{method:"GET",headers:{Authorization:`Bearer ${a}`,"x-api-bundleid":n}}),c=await r.json();if(r.ok&&Array.isArray(c.data))return c.data.find(s=>{var o;return((o=s.price)==null?void 0:o.id)===e})}catch(r){console.error("Lỗi lấy sản phẩm:",r)}return null}const i=[];for(let e=0;e<256;++e)i.push((e+256).toString(16).slice(1));function D(e,t=0){return(i[e[t+0]]+i[e[t+1]]+i[e[t+2]]+i[e[t+3]]+"-"+i[e[t+4]]+i[e[t+5]]+"-"+i[e[t+6]]+i[e[t+7]]+"-"+i[e[t+8]]+i[e[t+9]]+"-"+i[e[t+10]]+i[e[t+11]]+i[e[t+12]]+i[e[t+13]]+i[e[t+14]]+i[e[t+15]]).toLowerCase()}let m;const E=new Uint8Array(16);function P(){if(!m){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");m=crypto.getRandomValues.bind(crypto)}return m(E)}const V=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),b={randomUUID:V};function z(e,t,n){var r;if(b.randomUUID&&!e)return b.randomUUID();e=e||{};const a=e.random??((r=e.rng)==null?void 0:r.call(e))??P();if(a.length<16)throw new Error("Random bytes length must be >= 16");return a[6]=a[6]&15|64,a[8]=a[8]&63|128,D(a)}async function M(e){h();const t=L(),n=await j(t);localStorage.setItem("pkce_code_verifier",t),localStorage.setItem("idp",e),localStorage.setItem("deviceId","device-"+z());const a=U("com.astronex.hekaai"),r="application",c=window.location.origin+window.location.pathname,s=$(),o=`https://llm-oauth.apero.vn/realms/${a}/protocol/openid-connect/auth?`+new URLSearchParams({response_type:"code",client_id:r,redirect_uri:c,scope:"openid device-id profile email ancestor-id address phone group-membership",code_challenge:n,code_challenge_method:"S256",state:s,kc_idp_hint:e,prompt:"consent select_account"});p(),window.location.href=o}async function R(){try{const e=localStorage.getItem("refreshToken"),t="https://llm-account-service.apero.vn",n="com.astronex.hekaai";if(!e){window.location.href=localStorage.getItem("redirectUri")||"/",localStorage.clear();return}(await fetch(`${t}/saas-user-service/v1/users/logout`,{method:"POST",headers:{"Content-Type":"application/json","x-api-bundleid":n},body:JSON.stringify({refreshToken:e})})).ok&&(window.location.href=localStorage.getItem("redirectUri")||"/"),localStorage.clear()}catch{}}async function X(e){const t=localStorage.getItem("pkce_code_verifier"),n=localStorage.getItem("idp"),a=localStorage.getItem("deviceId"),r="com.astronex.hekaai",c="https://llm-account-service.apero.vn",s=window.location.origin+window.location.pathname;e&&(h(),fetch(c+"/saas-user-service/v1/users/silent-login-sso",{method:"POST",headers:{"Content-Type":"application/json","x-api-bundleid":r},body:JSON.stringify({code:e,codeVerifier:t,redirectUri:s,deviceId:a,idp:n})}).then(o=>o.json()).then(o=>{var l,u;if((l=o==null?void 0:o.data)!=null&&l.accessToken&&((u=o==null?void 0:o.data)!=null&&u.refreshToken)){localStorage.setItem("accessToken",o.data.accessToken),localStorage.setItem("refreshToken",o.data.refreshToken);const g=localStorage.getItem("priceId");g?(localStorage.removeItem("priceId"),B(g)):window.location.href=s}else p(),console.error("Login failed:",o),Swal.fire({title:"Login failed",text:"Please try again.",icon:"error",confirmButtonText:"OK"}).then(()=>{window.location.href=s})}).catch(o=>{p(),console.error("Error during login:",o)}))}async function Y(){var a,r;var e=localStorage.getItem("accessToken"),t="https://llm-account-service.apero.vn",n="com.astronex.hekaai";h();try{const c=await fetch(`${t}/saas-user-service/v1/users/me`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"x-api-bundleid":n}});p();const s=await c.json();if(c.ok&&s.data){const o=s.data;o.email&&localStorage.setItem("email",o.email);const l=((r=(a=o.groups)==null?void 0:a[0])==null?void 0:r.name)||null;l&&localStorage.setItem("group_name",l);const u=o.attributes||{};for(const g in u){const f=u[g];Array.isArray(f)&&localStorage.setItem(g,f[0])}return localStorage.getItem("gender")&&localStorage.getItem("year_of_birth")&&localStorage.getItem("activity")&&localStorage.getItem("measure_type")&&localStorage.getItem("current_weight")&&localStorage.getItem("current_height")&&localStorage.getItem("target_cal"),!1}else Swal.fire({title:"Session expired",text:"Please sign in again to continue.",icon:"warning",confirmButtonText:"OK"}).then(()=>{R(),showSignInModal(!0)})}catch{}p()}const N={class:"relative w-full max-w-sm mx-auto bg-white rounded-xl shadow-lg p-6"},H={class:"flex flex-col items-center text-center space-y-4 mt-4"},G=["disabled"],J=["disabled"],K={__name:"SignInModal",props:{visible:Boolean},emits:["close","login"],setup(e,{emit:t}){const n=v(!1),a=t,r=()=>a("close"),c=s=>{n.value=!0,M(s)};return(s,o)=>(y(),S(T,{name:"fade"},{default:k(()=>[e.visible?(y(),x("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center w-full h-full overflow-x-hidden overflow-y-auto bg-black bg-opacity-70",onKeydown:_(r,["esc"])},[d("div",N,[d("button",{onClick:r,class:"absolute top-3 right-3 z-20 w-6 h-6 text-black hover:bg-gray-100 rounded-full flex items-center justify-center text-xl"}," ✕ "),d("div",H,[o[4]||(o[4]=d("h2",{class:"text-lg font-semibold text-black"},"Login to Continue",-1)),d("button",{onClick:o[0]||(o[0]=l=>c("google")),disabled:n.value,class:"flex items-center justify-center w-full border border-gray-300 rounded-full py-2 px-4 text-black hover:bg-gray-100"},o[2]||(o[2]=[d("svg",{xmlns:"http://www.w3.org/2000/svg",class:"mr-2",x:"0px",y:"0px",width:"20",height:"20",viewBox:"0 0 48 48"},[d("path",{fill:"#fbc02d",d:"M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12	s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20	s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"}),d("path",{fill:"#e53935",d:"M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039	l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"}),d("path",{fill:"#4caf50",d:"M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36	c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"}),d("path",{fill:"#1565c0",d:"M43.611,20.083L43.595,20L42,20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571	c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"})],-1),w(" Continue with Google ")]),8,G),d("button",{onClick:o[1]||(o[1]=l=>c("apple")),disabled:n.value,class:"flex items-center justify-center w-full border border-gray-300 rounded-full py-2 px-4 text-black hover:bg-gray-100"},o[3]||(o[3]=[d("img",{src:"https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg",alt:"Apple",width:"18",height:"18",class:"mr-2"},null,-1),w(" Continue with Apple ")]),8,J)])])],32)):I("",!0)]),_:1}))}},q=C(K,[["__scopeId","data-v-5a001e88"]]),Z=Object.freeze(Object.defineProperty({__proto__:null,default:q},Symbol.toStringTag,{value:"Module"}));export{q as S,B as a,Z as b,Q as c,Y as g,R as h,M as l,X as s};
