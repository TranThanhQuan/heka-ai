import{e as w}from"./tracking-C0FP2swF.js";function S(e){return e.replace(/\./g,"-")}function I(){return Math.random().toString(36).substring(2,16)}function k(e=64){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";let n="";const o=new Uint8Array(e);return window.crypto.getRandomValues(o),o.forEach(i=>{n+=t[i%t.length]}),n}async function b(e){const n=new TextEncoder().encode(e),o=await window.crypto.subtle.digest("SHA-256",n);return v(o)}function v(e){const t=new Uint8Array(e);let n="";return t.forEach(o=>n+=String.fromCharCode(o)),btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function p(){document.body.style.overflow="hidden"}function g(){document.body.style.overflow="auto"}async function D(){try{let e=localStorage.getItem("accessToken");const t="https://payment-service.dev.apero.vn";if(!e)throw new Error("Access token not found in localStorage");const n=await fetch(`${t}/saas-payment-service/v1/stripe/billing-portal-session`,{method:"POST",headers:{"x-api-bundleid":"com.astronex.hekaai",Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({callbackUrl:"/"})});if(!n.ok){const i=await n.json();throw new Error(`Request failed: ${n.status} - ${i.message||"Unknown error"}`)}return(await n.json()).url}catch{return null}}async function T(e){showLoadingScreen();let t=localStorage.getItem("accessToken");const n="https://payment-service.dev.apero.vn",o="com.astronex.hekaai";localStorage.getItem("redirectUri");const i=window.location.origin,s=await x(e);if(console.log("product: ",s),!s){hideLoadingScreen();return}const d=Math.random().toString(36).substring(2,15);localStorage.setItem("checkoutId",d),localStorage.setItem("package_id",e);try{const a={cart:[{stripePriceId:s.price.id,quantity:1,name:s.name}],successUrl:`${i}/payment/success?id=${d}`,cancelUrl:`${i}/payment/cancel?id=${d}`},r=await fetch(`${n}/saas-payment-service/v1/stripe/create-checkout-session`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,"x-api-bundleid":o},body:JSON.stringify(a)}),c=await r.json();hideLoadingScreen(),r.ok&&(c!=null&&c.url)?(w("checkout_view"),window.location.href=c.url):(window.location.href="/",hideLoadingScreen())}catch{window.location.href="/",hideLoadingScreen()}}async function x(e){const t="https://payment-service.dev.apero.vn",n="com.astronex.hekaai",o=localStorage.getItem("accessToken");try{const i=await fetch(`${t}/saas-payment-service/v1/stripe/products`,{method:"GET",headers:{Authorization:`Bearer ${o}`,"x-api-bundleid":n}}),s=await i.json();if(i.ok&&Array.isArray(s.data))return s.data.find(d=>{var a;return((a=d.price)==null?void 0:a.id)===e})}catch(i){console.error("Lỗi lấy sản phẩm:",i)}return null}const l=[];for(let e=0;e<256;++e)l.push((e+256).toString(16).slice(1));function U(e,t=0){return(l[e[t+0]]+l[e[t+1]]+l[e[t+2]]+l[e[t+3]]+"-"+l[e[t+4]]+l[e[t+5]]+"-"+l[e[t+6]]+l[e[t+7]]+"-"+l[e[t+8]]+l[e[t+9]]+"-"+l[e[t+10]]+l[e[t+11]]+l[e[t+12]]+l[e[t+13]]+l[e[t+14]]+l[e[t+15]]).toLowerCase()}let h;const _=new Uint8Array(16);function $(){if(!h){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");h=crypto.getRandomValues.bind(crypto)}return h(_)}const A=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),y={randomUUID:A};function j(e,t,n){var i;if(y.randomUUID&&!e)return y.randomUUID();e=e||{};const o=e.random??((i=e.rng)==null?void 0:i.call(e))??$();if(o.length<16)throw new Error("Random bytes length must be >= 16");return o[6]=o[6]&15|64,o[8]=o[8]&63|128,U(o)}async function O(e){p();const t=k(),n=await b(t);localStorage.setItem("pkce_code_verifier",t),localStorage.setItem("idp",e),localStorage.setItem("deviceId","device-"+j());const o=S("com.astronex.hekaai"),i="application",s=window.location.origin+window.location.pathname,d=I(),a=`https://sso.dev.apero.vn/realms/${o}/protocol/openid-connect/auth?`+new URLSearchParams({response_type:"code",client_id:i,redirect_uri:s,scope:"openid device-id profile email ancestor-id address phone group-membership",code_challenge:n,code_challenge_method:"S256",state:d,kc_idp_hint:e,prompt:"consent select_account"});g(),window.location.href=a}async function f(){try{const e=localStorage.getItem("refreshToken"),t="https://id.dev.apero.vn",n="com.astronex.hekaai";if(!e){window.location.href=localStorage.getItem("redirectUri")||"/",localStorage.clear();return}(await fetch(`${t}/saas-user-service/v1/users/logout`,{method:"POST",headers:{"Content-Type":"application/json","x-api-bundleid":n},body:JSON.stringify({refreshToken:e})})).ok&&(window.location.href=localStorage.getItem("redirectUri")||"/"),localStorage.clear()}catch{}}async function C(e){const t=localStorage.getItem("priceId");localStorage.removeItem("priceId");const n=localStorage.getItem("pkce_code_verifier"),o=localStorage.getItem("idp"),i=localStorage.getItem("deviceId"),s="com.astronex.hekaai",d="https://id.dev.apero.vn",a=window.location.origin+window.location.pathname;e&&(p(),fetch(d+"/saas-user-service/v1/users/silent-login-sso",{method:"POST",headers:{"Content-Type":"application/json","x-api-bundleid":s},body:JSON.stringify({code:e,codeVerifier:n,redirectUri:a,deviceId:i,idp:o})}).then(r=>r.json()).then(r=>{var c,u;(c=r==null?void 0:r.data)!=null&&c.accessToken&&((u=r==null?void 0:r.data)!=null&&u.refreshToken)?(localStorage.setItem("accessToken",r.data.accessToken),localStorage.setItem("refreshToken",r.data.refreshToken),t?T(t):window.location.href=a):(g(),console.error("Login failed:",r),Swal.fire({title:"Login failed",text:"Please try again.",icon:"error",confirmButtonText:"OK"}).then(()=>{window.location.href=a}))}).catch(r=>{g(),console.error("Error during login:",r)}))}async function E(){var o,i;var e=localStorage.getItem("accessToken"),t="https://id.dev.apero.vn",n="com.astronex.hekaai";p();try{const s=await fetch(`${t}/saas-user-service/v1/users/me`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"x-api-bundleid":n}});g();const d=await s.json();if(s.ok&&d.data){const a=d.data;a.email&&localStorage.setItem("email",a.email);const r=((i=(o=a.groups)==null?void 0:o[0])==null?void 0:i.name)||null;r&&localStorage.setItem("group_name",r);const c=a.attributes||{};for(const u in c){const m=c[u];Array.isArray(m)&&localStorage.setItem(u,m[0])}return localStorage.getItem("gender")&&localStorage.getItem("year_of_birth")&&localStorage.getItem("activity")&&localStorage.getItem("measure_type")&&localStorage.getItem("current_weight")&&localStorage.getItem("current_height")&&localStorage.getItem("target_cal"),!1}else Swal.fire({title:"Session expired",text:"Please sign in again to continue.",icon:"warning",confirmButtonText:"OK"}).then(()=>{f(),showSignInModal(!0)})}catch{}g()}async function P(e){var d;let t=localStorage.getItem("accessToken");const n="com.astronex.hekaai",o="https://id.dev.apero.vn";if(!t){console.error("❌ Access token is missing");return}const s={attributes:Object.entries(e).reduce((a,[r,c])=>(c!==void 0&&c!==""&&(typeof c=="string"&&(c=c.trim(),(c.startsWith('"')&&c.endsWith('"')||c.startsWith("'")&&c.endsWith("'"))&&(c=c.slice(1,-1))),a[r]=c),a),{})};console.log("✅ payload sau khi xử lý:",s);try{const a=await fetch(`${o}/saas-user-service/v1/users/update`,{method:"PUT",headers:{"Content-Type":"application/json","x-api-bundleid":n,Authorization:`Bearer ${t}`},body:JSON.stringify(s)}),r=await a.json();a.ok&&r.data===!0||(((d=r==null?void 0:r.error)==null?void 0:d.message)==="Token expired"?f():console.error("❌ Update failed:",r))}catch(a){console.error("❌ Error while updating profile:",a)}finally{g()}}export{T as a,D as c,E as g,f as h,O as l,C as s,P as u};
